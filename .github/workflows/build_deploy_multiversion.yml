name: Build and deploy multi-version OpenSPP documentation

# This workflow builds and deploys multi-version documentation:
# - v2.0 (latest) from v2-odoo19-doc-refresh branch → root (/)
# - v1.3 from stable branch → /v1.3/

on:
  push:
    branches:
      - stable  # Only run on stable branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  build_multiversion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout stable branch
        uses: actions/checkout@v3
        with:
          ref: stable
          fetch-depth: 0  # Fetch all history for branch switching
          submodules: true

      - name: Setup Graphviz
        uses: ts-graphviz/setup-graphviz@v1

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsasl2-dev libldap2-dev libssl-dev

      # ============================================
      # BUILD v1.3 (from stable branch)
      # ============================================
      - name: Install v1.3 dependencies (stable)
        run: |
          pip install -q -r requirements_frozen.txt

      - name: Build v1.3 documentation
        run: |
          set -e
          rm -rf _build/
          export DOCS_VERSION=1.3
          export DOCS_BASEURL=https://docs.openspp.org/v1.3/
          sphinx-build -b html docs _build/html/v1.3
          echo "✅ v1.3 build complete"

      # ============================================
      # BUILD v2.0 (from v2-odoo19-doc-refresh branch)
      # ============================================
      - name: Checkout v2 docs
        run: |
          # Save v1.3 build
          mv _build/html/v1.3 /tmp/v1.3-build

          # Checkout v2 branch
          git checkout v2-odoo19-doc-refresh
          git submodule update --init --recursive

      - name: Install v2.0 dependencies
        run: |
          # Install any additional requirements for v2
          pip install -q -r requirements_frozen.txt || pip install -q -r requirements.txt

      - name: Build v2.0 documentation (root)
        run: |
          set -e
          rm -rf _build/
          export DOCS_VERSION=2.0
          export DOCS_BASEURL=https://docs.openspp.org/
          sphinx-build -b html docs _build/html
          echo "✅ v2.0 build complete"

      # ============================================
      # COMBINE BUILDS & SETUP VERSION SWITCHER
      # ============================================
      - name: Combine builds
        run: |
          # Move v1.3 build back
          mv /tmp/v1.3-build _build/html/v1.3
          echo "✅ Combined v2.0 (root) and v1.3 (/v1.3/)"

      - name: Setup version switcher
        run: |
          set -e

          # Create production switcher.json
          cat > _build/html/_static/switcher.json << 'EOF'
          [
              {
                  "name": "2.0 (latest)",
                  "version": "2.0",
                  "url": "https://docs.openspp.org/"
              },
              {
                  "name": "1.3",
                  "version": "1.3",
                  "url": "https://docs.openspp.org/v1.3/"
              }
          ]
          EOF

          # Copy to v1.3
          cp _build/html/_static/switcher.json _build/html/v1.3/_static/

          # Copy version_switcher.js to both (if not already present)
          if [ -f "docs/_static/version_switcher.js" ]; then
            cp docs/_static/version_switcher.js _build/html/_static/
            cp docs/_static/version_switcher.js _build/html/v1.3/_static/
          fi

          echo "✅ Version switcher configured"

      - name: Inject version switcher script
        run: |
          # Inject script tag into all HTML files that don't already have it
          find _build/html -name "*.html" -exec grep -L "version_switcher.js" {} \; | \
            xargs -I {} sed -i 's|</body>|<script src="/_static/version_switcher.js"></script></body>|g' {}

          echo "✅ Version switcher script injected"

      - name: Display build summary
        run: |
          echo "============================================"
          echo "Multi-version documentation build complete"
          echo "============================================"
          echo ""
          echo "v2.0 (root):"
          ls -la _build/html/ | head -10
          echo ""
          echo "v1.3 (/v1.3/):"
          ls -la _build/html/v1.3/ | head -10
          echo ""
          echo "Version switcher:"
          cat _build/html/_static/switcher.json

      # ============================================
      # DEPLOY TO CF-PAGES
      # ============================================
      - name: Deploy to cf-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _build/html
          publish_branch: cf-pages
          keep_files: true  # Preserve preview deployments

      - name: Display deployment status
        run: |
          echo "============================================"
          echo "✅ Multi-version documentation deployed!"
          echo "============================================"
          echo ""
          echo "URLs:"
          echo "  - v2.0 (latest): https://docs.openspp.org/"
          echo "  - v1.3:          https://docs.openspp.org/v1.3/"
